name: Market Radar Daily

on:
  schedule:
    # GitHub schedule can be delayed; we trigger earlier (06:00 KST = 21:00 UTC)
    # and then wait until 09:00 KST inside the job.
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      skip_wait:
        description: "Skip waiting until 09:00 KST (manual runs)"
        required: false
        default: "true"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      TZ: Asia/Seoul
      ENV_B64: ${{ secrets.ENV_B64 }}
      MARKET_RADER_SECRET_YML: ${{ secrets.MARKET_RADER_SECRET_YML }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Wait until 09:00 KST
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_wait != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Now (KST): $(date)"
          target="$(date -d 'today 09:00' +%s)"
          now="$(date +%s)"
          if [ "$now" -lt "$target" ]; then
            wait="$((target - now))"
            echo "Sleeping ${wait}s until 09:00 KST..."
            sleep "$wait"
          else
            echo "Already past 09:00 KST; continuing."
          fi
          echo "Start (KST): $(date)"
      - name: Validate secrets
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ENV_B64_LEN=${#ENV_B64}"
          echo "MARKET_RADER_SECRET_YML_LEN=${#MARKET_RADER_SECRET_YML}"
          echo "GEMINI_API_KEY_LEN=${#GEMINI_API_KEY}"
          if [ -n "$MARKET_RADER_SECRET_YML" ]; then
            if printf "%s" "$MARKET_RADER_SECRET_YML" | grep -q 'GEMINI_API_KEY'; then
              echo "MARKET_RADER_SECRET_YML_HAS_GEMINI_API_KEY=true"
            else
              echo "MARKET_RADER_SECRET_YML_HAS_GEMINI_API_KEY=false"
            fi
          fi
          if [ -z "$ENV_B64" ] && [ -z "$MARKET_RADER_SECRET_YML" ] && [ -z "$GEMINI_API_KEY" ]; then
            echo "Missing configuration:"
            echo "- Set either Secrets.ENV_B64 (base64 of full .env) OR Secrets.MARKET_RADER_SECRET_YML (yaml/.env content) OR Secrets.GEMINI_API_KEY (+ SMTP secrets)."
            exit 1
          fi
      - name: Install
        run: npm ci
      - name: Restore seen history cache
        uses: actions/cache@v4
        with:
          path: out/seen.json
          key: seen-v1-${{ github.run_id }}
          restore-keys: |
            seen-v1-
      - name: Run report (ENV_B64)
        if: env.ENV_B64 != ''
        run: |
          printf "%s" "$ENV_B64" | base64 --decode > .env
          if ! grep -qE '^GEMINI_API_KEY=.+$' .env; then
            echo "ENV_B64 decoded, but GEMINI_API_KEY is missing/empty in .env"
            exit 1
          fi
          npm run report

      - name: Run report (MARKET_RADER_SECRET_YML)
        if: env.ENV_B64 == '' && env.MARKET_RADER_SECRET_YML != ''
        shell: bash
        run: |
          set -euo pipefail
          raw="$MARKET_RADER_SECRET_YML"

          # If it looks like base64, try decoding once.
          if printf "%s" "$raw" | grep -Eq '^[A-Za-z0-9+/=]+$'; then
            decoded="$(printf "%s" "$raw" | base64 --decode 2>/dev/null || true)"
            if printf "%s" "$decoded" | grep -qE 'GEMINI_API_KEY|SMTP_HOST|MAIL_TO'; then
              raw="$decoded"
            fi
          fi

          if ! printf "%s" "$raw" | grep -q 'GEMINI_API_KEY'; then
            echo "MARKET_RADER_SECRET_YML does not contain GEMINI_API_KEY. Provide either dotenv lines (GEMINI_API_KEY=...) or YAML (GEMINI_API_KEY: ...)."
            exit 1
          fi

          # If it's already dotenv format, write as-is.
          first_nonempty="$(printf "%s\n" "$raw" | sed -e 's/\r$//' | sed -n '/^[[:space:]]*#/d;/^[[:space:]]*$/d;p' | head -n 1 || true)"
          if printf "%s" "$first_nonempty" | grep -q '='; then
            printf "%s\n" "$raw" > .env
            if ! grep -qE '^GEMINI_API_KEY=.+$' .env; then
              echo "MARKET_RADER_SECRET_YML dotenv detected, but GEMINI_API_KEY is missing/empty"
              exit 1
            fi
            npm run report
            exit 0
          fi

          # Parse a simple YAML mapping (KEY: value) into dotenv.
          printf "%s\n" "$raw" | awk '
            function ltrim(s){ sub(/^[ \t\r\n]+/, "", s); return s }
            function rtrim(s){ sub(/[ \t\r\n]+$/, "", s); return s }
            function trim(s){ return rtrim(ltrim(s)) }
            /^[ \t]*#/ { next }
            /^[ \t]*$/ { next }
            {
              line=$0
              sub(/\r$/, "", line)
              pos = index(line, ":")
              if (pos <= 1) next
              key = trim(substr(line, 1, pos-1))
              val = trim(substr(line, pos+1))
              if (key ~ /^[A-Za-z_][A-Za-z0-9_]*$/) {
                print key "=" val
              }
            }
          ' > .env

          if ! grep -qE '^GEMINI_API_KEY=.+$' .env; then
            echo "MARKET_RADER_SECRET_YML YAML parsed, but GEMINI_API_KEY is missing/empty"
            exit 1
          fi

          npm run report

      - name: Run report (secrets)
        if: env.ENV_B64 == '' && env.MARKET_RADER_SECRET_YML == ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-2.5-flash' }}
          REQUIRE_GROUNDING: ${{ secrets.REQUIRE_GROUNDING || 'false' }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          MAIL_SUBJECT_PREFIX: ${{ secrets.MAIL_SUBJECT_PREFIX || '[Market Radar]' }}
          TZ: Asia/Seoul
        run: npm run report
